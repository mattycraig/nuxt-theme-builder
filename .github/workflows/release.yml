name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

permissions:
  contents: write

jobs:
  # Job 1: Bump version, generate changelog, create tag (manual trigger only)
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version and generate changelog
        id: bump
        run: |
          pnpm changelogen --${{ inputs.bump }} --push
          NEW_TAG=$(git describe --tags --abbrev=0)
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

  # Job 2: Create GitHub Release (runs on tag push or after bump)
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [bump-version]
    if: always() && (github.event_name == 'push' || needs.bump-version.result == 'success')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.bump-version.outputs.new_tag || github.ref }}

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Extract changelog for this version
        id: changelog
        run: |
          TAG="${{ needs.bump-version.outputs.new_tag || github.ref_name }}"
          # Extract section for this version from CHANGELOG.md
          pnpm changelogen --output temp-changelog.md --from $(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "") --to $TAG
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat temp-changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.bump-version.outputs.new_tag || github.ref_name }}
          name: Release ${{ needs.bump-version.outputs.new_tag || github.ref_name }}
          body: ${{ steps.changelog.outputs.body }}
          draft: false
          prerelease: ${{ contains(needs.bump-version.outputs.new_tag || github.ref_name, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
