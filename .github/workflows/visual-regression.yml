name: Visual Regression

on:
  pull_request:
    branches: [master]
    paths:
      - "app/components/**"
      - "app/pages/**"
      - "app/layouts/**"
      - "app/assets/**"
      - "*.css"
      - "tailwind.config.*"

permissions:
  contents: read
  pull-requests: write

jobs:
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: playwright-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright system deps
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Build app
        run: pnpm build
        env:
          NODE_OPTIONS: --max-old-space-size=8192

      - name: Run visual regression tests
        run: pnpm test:e2e tests/e2e/visual/
        env:
          VISUAL_REGRESSION: true

      - name: Upload screenshot diffs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-diffs-${{ github.run_id }}
          path: |
            tests/e2e/test-results/
            tests/e2e/screenshots/
          retention-days: 14

      - name: Comment on PR with diff results
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const diffDir = 'tests/e2e/test-results';
            let diffFiles = [];

            if (fs.existsSync(diffDir)) {
              const walk = (dir) => {
                const files = fs.readdirSync(dir);
                for (const file of files) {
                  const filepath = path.join(dir, file);
                  if (fs.statSync(filepath).isDirectory()) {
                    walk(filepath);
                  } else if (file.includes('diff') && file.endsWith('.png')) {
                    diffFiles.push(filepath);
                  }
                }
              };
              walk(diffDir);
            }

            const body = [
              '### üñºÔ∏è Visual Regression Failed',
              '',
              `Found ${diffFiles.length} visual difference(s).`,
              '',
              'Download the artifacts from this workflow run to review the diffs.',
              '',
              '**To update baselines:**',
              '```bash',
              'pnpm test:e2e tests/e2e/visual/ --update-snapshots',
              '```',
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
